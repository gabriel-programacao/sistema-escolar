<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAF PE | Terminal</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { background: #003399; color: white; font-family: sans-serif; text-align: center; margin: 0; }
        .header { background: white; color: #003399; padding: 15px; font-weight: bold; border-bottom: 5px solid #ffcc00; }
        video { width: 90%; max-width: 500px; border: 5px solid white; border-radius: 20px; margin-top: 20px; transform: scaleX(-1); }
        .res { margin-top: 20px; font-size: 2rem; font-weight: bold; min-height: 100px; }
        .nome { background: #10b981; padding: 15px; border-radius: 50px; display: inline-block; }
    </style>
</head>
<body>
    <div class="header">SIAF PE - RECONHECIMENTO FACIAL</div>
    <video id="v" autoplay muted playsinline></video>
    <div class="res" id="d">Posicione-se para a frequência</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgR98RtL8sgxVbEV2Swyb2wnHLSPt3cDo",
            authDomain: "escolapro-15e5e.firebaseapp.com",
            projectId: "escolapro-15e5e",
            storageBucket: "escolapro-15e5e.firebasestorage.app",
            messagingSenderId: "339019791514",
            appId: "1:339019791514:web:44e0d58b6835f0fe6df323"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function run() {
            const URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(URL);

            document.getElementById('v').srcObject = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            
            const snap = await getDocs(collection(db, "alunos"));
            const desc = snap.docs.map(d => new faceapi.LabeledFaceDescriptors(d.data().nome, [new Float32Array(d.data().descritor)]));
            
            if(desc.length === 0) return;
            const matcher = new faceapi.FaceMatcher(desc, 0.6);
            let lock = false;

            setInterval(async () => {
                if(lock) return;
                const det = await faceapi.detectSingleFace(v, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if(det) {
                    const m = matcher.findBestMatch(det.descriptor);
                    if(m.label !== 'unknown') {
                        lock = true;
                        document.getElementById('d').innerHTML = `<div class="nome">BEM-VINDO<br>${m.label}</div>`;
                        await addDoc(collection(db, "frequencia"), { nome: m.label, data: new Date().toLocaleDateString('pt-BR'), hora: new Date().toLocaleTimeString('pt-BR') });
                        setTimeout(() => { document.getElementById('d').innerText = "Aguardando próximo..."; lock = false; }, 3000);
                    }
                }
            }, 800);
        }
        run();
    </script>
</body>
</html>