<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAF PE | Terminal de Frequência</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --ete-blue: #004a99; --ete-yellow: #ffcc00; }
        body { background: var(--ete-blue); color: white; font-family: 'Poppins', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .glass-terminal { background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); border-radius: 40px; padding: 30px; border: 2px solid rgba(255,255,255,0.2); width: 90%; max-width: 600px; text-align: center; }
        video { width: 100%; border-radius: 30px; border: 6px solid white; transform: scaleX(-1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .footer-pe { position: fixed; bottom: 20px; font-size: 0.8rem; opacity: 0.7; }
        .msg-box { margin-top: 25px; font-size: 1.8rem; font-weight: 700; height: 80px; }
        .btn-back { position: fixed; top: 20px; left: 20px; background: white; color: var(--ete-blue); border-radius: 30px; padding: 10px 20px; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <a href="index.html" class="btn-back"><i class="fas fa-arrow-left"></i> Voltar</a>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/Logo_da_Educa%C3%A7%C3%A3o_Pernambuco.png/1200px-Logo_da_Educa%C3%A7%C3%A3o_Pernambuco.png" height="50" class="mb-3">
    
    <div class="glass-terminal shadow-lg">
        <video id="video" autoplay muted playsinline></video>
        <div class="msg-box" id="display">Aguardando Identificação...</div>
    </div>

    <div class="footer-pe">SIAF PE - Secretaria de Educação e Esportes</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyDgR98RtL8sgxVbEV2Swyb2wnHLSPt3cDo", authDomain: "escolapro-15e5e.firebaseapp.com", projectId: "escolapro-15e5e", storageBucket: "escolapro-15e5e.firebasestorage.app", messagingSenderId: "339019791514", appId: "1:339019791514:web:44e0d58b6835f0fe6df323" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        async function init() {
            const URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(URL);
            document.getElementById('video').srcObject = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            
            const snap = await getDocs(collection(db, "alunos"));
            const labled = snap.docs.map(d => new faceapi.LabeledFaceDescriptors(d.data().nome, [new Float32Array(d.data().descritor)]));
            if(labled.length === 0) return;
            const matcher = new faceapi.FaceMatcher(labled, 0.55);
            let lock = false;

            setInterval(async () => {
                if(lock) return;
                const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if(det) {
                    const m = matcher.findBestMatch(det.descriptor);
                    if(m.label !== 'unknown') {
                        lock = true;
                        document.getElementById('display').innerHTML = `<span style="background:#ffcc00; color:#004a99; padding:10px 30px; border-radius:50px;">BEM-VINDO: ${m.label}</span>`;
                        await addDoc(collection(db, "frequencia"), { nome: m.label, data: new Date().toLocaleDateString('pt-BR'), hora: new Date().toLocaleTimeString('pt-BR') });
                        setTimeout(() => { document.getElementById('display').innerText = "Aguardando Identificação..."; lock = false; }, 4000);
                    }
                }
            }, 800);
        }
        init();
    </script>
</body>
</html>