<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIAF PE | Gest√£o de Frequ√™ncia</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #003399; --accent: #ffcc00; --red: #cc0000; --bg: #f0f2f5; }
        body { background: var(--bg); font-family: 'Inter', sans-serif; margin: 0; }

        /* TOP BAR */
        .top-bar {
            background: white; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; border-bottom: 4px solid var(--accent);
        }
        .user-info { display: flex; align-items: center; gap: 15px; font-weight: 600; color: var(--primary); }
        .btn-logout { background: var(--red); color: white; border: none; padding: 6px 15px; border-radius: 8px; font-size: 0.85rem; transition: 0.3s; }
        .btn-logout:hover { opacity: 0.8; transform: scale(0.95); }

        /* LAYOUT MAIN */
        .wrapper { display: flex; min-height: calc(100vh - 70px); }
        .sidebar { 
            width: 260px; background: var(--primary); padding: 20px; flex-shrink: 0; 
            display: flex; flex-direction: column; gap: 10px;
        }
        .main-content { flex-grow: 1; padding: 30px; }

        /* BUTTONS SIDEBAR */
        .nav-link-pe {
            color: rgba(255,255,255,0.7); text-decoration: none; padding: 12px 15px; border-radius: 10px;
            display: flex; align-items: center; gap: 12px; transition: 0.3s; font-size: 0.95rem; border: none; background: none; width: 100%; text-align: left;
        }
        .nav-link-pe:hover, .nav-link-pe.active { background: rgba(255,255,255,0.1); color: var(--accent); }

        /* CARDS */
        .card-custom { background: white; border-radius: 20px; border: none; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .stat-box { border-radius: 15px; padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center; }
        
        /* VIDEO */
        video { width: 100%; border-radius: 20px; background: #000; transform: scaleX(-1); border: 4px solid white; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        
        .secao { display: none; }
        .ativa { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* MOBILE */
        @media (max-width: 992px) {
            .sidebar { display: none; }
            .top-bar { padding: 10px 15px; }
            .user-info span { display: none; }
        }
    </style>
</head>
<body>

    <header class="top-bar">
        <div class="d-flex align-items-center gap-2">
            <img src="https://www.pe.gov.br/wp-content/themes/governo-pe/assets/images/brasao-pe.png" height="40" alt="PE">
            <div class="fw-bold d-none d-md-block" style="line-height: 1; color: var(--primary);">GOVERNO DE<br><small>PERNAMBUCO</small></div>
        </div>
        <div class="user-info">
            <i class="fas fa-user-circle fa-lg"></i>
            <span>Logado como: <strong id="username-display">---</strong></span>
            <button class="btn-logout" onclick="window.logout()"><i class="fas fa-power-off"></i> Sair</button>
        </div>
    </header>

    <div class="wrapper">
        <aside class="sidebar">
            <div id="menu-links"></div>
        </aside>

        <main class="main-content">
            <div id="sec-stats" class="secao ativa">
                <h4 class="fw-bold mb-4 text-dark">Monitoramento em Tempo Real</h4>
                <div class="row g-4">
                    <div class="col-md-4"><div class="stat-box" style="background: var(--primary)"><div><small>Matriculados</small><h2 id="st-total">0</h2></div><i class="fas fa-users fa-2x opacity-50"></i></div></div>
                    <div class="col-md-4"><div class="stat-box" style="background: #10b981"><div><small>Presen√ßas Hoje</small><h2 id="st-presentes">0</h2></div><i class="fas fa-check-circle fa-2x opacity-50"></i></div></div>
                    <div class="col-md-4"><div class="stat-box" style="background: var(--red)"><div><small>Faltas</small><h2 id="st-faltas">0</h2></div><i class="fas fa-user-times fa-2x opacity-50"></i></div></div>
                </div>
                <div class="row mt-4 g-4">
                    <div class="col-lg-8"><div class="card-custom"><h5>Fluxo de Entrada</h5><canvas id="chartBarras" height="150"></canvas></div></div>
                    <div class="col-lg-4"><div class="card-custom"><h5>Assiduidade</h5><canvas id="chartPizza"></canvas></div></div>
                </div>
            </div>

            <div id="sec-faltas" class="secao">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold text-dark">Base de Alunos</h4>
                    <input type="text" id="buscaA" class="form-control w-50 rounded-pill shadow-sm" placeholder="üîç Pesquisar por nome ou turma..." onkeyup="window.filtrarAlunos()">
                </div>
                <div class="card-custom p-0 overflow-hidden">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light"><tr><th>Estudante</th><th>Turma</th><th class="text-center">A√ß√µes</th></tr></thead>
                        <tbody id="tabelaAlunos"></tbody>
                    </table>
                </div>
            </div>

            <div id="sec-facial" class="secao">
                <h4 class="fw-bold mb-4">Matr√≠cula de Estudante</h4>
                <div class="card-custom">
                    <div class="row g-4">
                        <div class="col-lg-5">
                            <label class="small fw-bold mb-1">NOME COMPLETO</label>
                            <input type="text" id="nAluno" class="form-control mb-3" placeholder="Ex: Jo√£o Silva">
                            <label class="small fw-bold mb-1">TURMA / S√âRIE</label>
                            <input type="text" id="sAluno" class="form-control mb-4" placeholder="Ex: 3¬∫ B - Redes">
                            <button class="btn btn-primary w-100 py-3 mb-2 fw-bold" id="btnCam"><i class="fas fa-camera me-2"></i> Abrir C√¢mera</button>
                            <button class="btn btn-success w-100 py-3 fw-bold" id="btnSalvar"><i class="fas fa-save me-2"></i> Finalizar Cadastro</button>
                        </div>
                        <div class="col-lg-7 text-center"><video id="webcam" autoplay muted playsinline></video></div>
                    </div>
                </div>
            </div>

            <div id="sec-consultas" class="secao">
                <h4 class="fw-bold mb-4 text-dark">Relat√≥rios Oficiais</h4>
                <div class="card-custom mb-4">
                    <div class="row g-3">
                        <div class="col-md-5"><label class="small fw-bold">SELECIONE O DIA</label><input type="date" id="filtroData" class="form-control"></div>
                        <div class="col-md-7 d-flex align-items-end gap-2">
                            <button class="btn btn-primary flex-grow-1" onclick="window.gerarRelatorio()"><i class="fas fa-search"></i> Consultar</button>
                            <button class="btn btn-danger" onclick="window.baixarPDF()"><i class="fas fa-file-pdf"></i> Exportar</button>
                        </div>
                    </div>
                </div>
                <div class="card-custom p-0 overflow-hidden"><table class="table mb-0"><thead><tr><th>Nome</th><th>Hora de Registro</th></tr></thead><tbody id="tabelaRelatorio"></tbody></table></div>
            </div>

            <div id="sec-usuarios" class="secao">
                <h4 class="fw-bold mb-4">Operadores do Sistema</h4>
                <div class="card-custom mb-4">
                    <div class="row g-2 mb-3">
                        <div class="col-md-4"><input type="text" id="lu" class="form-control" placeholder="Usu√°rio"></div>
                        <div class="col-md-4"><input type="password" id="ls" class="form-control" placeholder="Senha"></div>
                        <div class="col-md-4"><input type="email" id="le" class="form-control" placeholder="E-mail de recupera√ß√£o"></div>
                    </div>
                    <div class="d-flex flex-wrap gap-3 mb-4 p-2 bg-light rounded">
                        <label><input type="checkbox" class="pc" value="aba-stats"> Painel</label>
                        <label><input type="checkbox" class="pc" value="aba-consultas"> Relat√≥rios</label>
                        <label><input type="checkbox" class="pc" value="aba-facial"> Matr√≠cula</label>
                        <label><input type="checkbox" class="pc" value="aba-faltas"> Alunos</label>
                        <label><input type="checkbox" class="pc" value="aba-usuarios"> Sistemas</label>
                    </div>
                    <button class="btn btn-primary px-5" id="btnL">Criar Novo Login</button>
                </div>
                <div class="d-flex justify-content-between mb-2"><h5>Listagem de Acessos</h5><input type="text" id="buscaL" class="form-control w-25 rounded-pill shadow-sm" placeholder="Buscar login..." onkeyup="window.filtrarLogins()"></div>
                <div class="card-custom p-0 overflow-hidden"><table class="table mb-0"><thead><tr class="table-dark"><th>Usu√°rio</th><th class="text-end">Gerir</th></tr></thead><tbody id="tabelaLogins"></tbody></table></div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="modalL" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0 bg-primary text-white"><h5>Editar Acesso</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body p-4">
            <input type="hidden" id="eid"><label class="small fw-bold">NOME DE USU√ÅRIO</label><input type="text" id="eu" class="form-control mb-3">
            <label class="small fw-bold">NOVA SENHA (DEIXE VAZIO SE N√ÉO MUDAR)</label><input type="password" id="es" class="form-control mb-3">
            <label class="small fw-bold">E-MAIL</label><input type="email" id="ee" class="form-control mb-4">
            <h6>Permiss√µes do M√≥dulo</h6>
            <div id="ep" class="d-flex flex-wrap gap-2 p-3 bg-light rounded">
                <label><input type="checkbox" class="pce" value="aba-stats"> Painel</label>
                <label><input type="checkbox" class="pce" value="aba-consultas"> Relat√≥rios</label>
                <label><input type="checkbox" class="pce" value="aba-facial"> Matr√≠cula</label>
                <label><input type="checkbox" class="pce" value="aba-faltas"> Alunos</label>
                <label><input type="checkbox" class="pce" value="aba-usuarios"> Sistemas</label>
            </div>
        </div>
        <div class="modal-footer border-0"><button class="btn btn-primary w-100" onclick="window.salvarEL()">Confirmar Altera√ß√µes</button></div>
    </div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgR98RtL8sgxVbEV2Swyb2wnHLSPt3cDo",
            authDomain: "escolapro-15e5e.firebaseapp.com",
            projectId: "escolapro-15e5e",
            storageBucket: "escolapro-15e5e.firebasestorage.app",
            messagingSenderId: "339019791514",
            appId: "1:339019791514:web:44e0d58b6835f0fe6df323"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const logado = JSON.parse(localStorage.getItem('usuarioLogado'));
        let chartB = null, chartP = null;

        window.onload = () => {
            if(!logado) window.location.href = 'index.html';
            document.getElementById('username-display').innerText = logado.usuario;
            montarMenu();
            initIA();
            escutarDados();
        };

        window.logout = () => { localStorage.removeItem('usuarioLogado'); window.location.href = 'index.html'; };

        function montarMenu() {
            const itens = [
                { id: 'sec-stats', label: 'Dashboard', icon: 'fa-chart-line' },
                { id: 'sec-consultas', label: 'Relat√≥rios', icon: 'fa-print' },
                { id: 'sec-facial', label: 'Matr√≠cula', icon: 'fa-id-card' },
                { id: 'sec-faltas', label: 'Alunos', icon: 'fa-users' },
                { id: 'sec-usuarios', label: 'Sistemas', icon: 'fa-cogs' }
            ];
            let h = "";
            itens.forEach(i => {
                if(logado.usuario === 'M√°rcio' || (logado.permissoes && logado.permissoes.includes(i.id.replace('sec-', 'aba-')))) {
                    h += `<button class="nav-link-pe" onclick="window.trocarAba('${i.id}', this)"><i class="fas ${i.icon}"></i> ${i.label}</button>`;
                }
            });
            document.getElementById('menu-links').innerHTML = h;
            document.querySelector('.nav-link-pe').classList.add('active');
        }

        window.trocarAba = (id, btn) => {
            document.querySelectorAll('.secao').forEach(s => s.classList.remove('ativa'));
            document.getElementById(id).classList.add('ativa');
            document.querySelectorAll('.nav-link-pe').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        };

        async function initIA() {
            const URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(URL);
            await faceapi.nets.faceRecognitionNet.loadFromUri(URL);
        }

        document.getElementById('btnCam').onclick = async () => {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            document.getElementById('webcam').srcObject = s;
        };

        document.getElementById('btnSalvar').onclick = async () => {
            const n = document.getElementById('nAluno').value, s = document.getElementById('sAluno').value, v = document.getElementById('webcam');
            const det = await faceapi.detectSingleFace(v, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if(!det) return alert("Rosto n√£o detectado!");
            await addDoc(collection(db, "alunos"), { nome: n, sala: s, descritor: Array.from(det.descriptor) });
            alert("Sucesso!"); location.reload();
        };

        function escutarDados() {
            onSnapshot(collection(db, "alunos"), snap => {
                const t = document.getElementById('tabelaAlunos'); t.innerHTML = "";
                snap.forEach(d => { t.innerHTML += `<tr><td class="fw-bold">${d.data().nome}</td><td>${d.data().sala}</td><td class="text-center"><button class="btn btn-sm btn-light text-danger" onclick="window.del('alunos','${d.id}')"><i class="fas fa-trash"></i></button></td></tr>`; });
                document.getElementById('st-total').innerText = snap.size;
                updateCharts();
            });
            const hoje = new Date().toLocaleDateString('pt-BR');
            onSnapshot(collection(db, "frequencia"), snap => {
                let p = 0; snap.forEach(d => { if(d.data().data === hoje) p++; });
                document.getElementById('st-presentes').innerText = p;
                document.getElementById('st-faltas').innerText = Math.max(0, parseInt(document.getElementById('st-total').innerText) - p);
                updateCharts();
            });
            onSnapshot(collection(db, "logins"), snap => {
                const t = document.getElementById('tabelaLogins'); t.innerHTML = "";
                snap.forEach(d => { t.innerHTML += `<tr><td>${d.data().usuario}</td><td class="text-end"><button class="btn btn-sm btn-light text-primary" onclick='window.editL("${d.id}","${d.data().usuario}","${d.data().email}",${JSON.stringify(JSON.stringify(d.data().permissoes))})'><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-light text-danger" onclick="window.del('logins','${d.id}')"><i class="fas fa-trash"></i></button></td></tr>`; });
            });
        }

        window.editL = (id, u, e, p) => {
            document.getElementById('eid').value = id; document.getElementById('eu').value = u; document.getElementById('ee').value = e;
            const perms = JSON.parse(p); document.querySelectorAll('.pce').forEach(c => c.checked = perms.includes(c.value));
            new bootstrap.Modal(document.getElementById('modalL')).show();
        };

        window.salvarEL = async () => {
            const data = { usuario: document.getElementById('eu').value, email: document.getElementById('ee').value, permissoes: Array.from(document.querySelectorAll('.pce:checked')).map(c => c.value) };
            if(document.getElementById('es').value) data.senha = document.getElementById('es').value;
            await updateDoc(doc(db, "logins", document.getElementById('eid').value), data);
            location.reload();
        };

        window.gerarRelatorio = async () => {
            const df = document.getElementById('filtroData').value;
            if(!df) return alert("Selecione a data");
            const dataBR = df.split('-').reverse().join('/');
            const q = query(collection(db, "frequencia"), where("data", "==", dataBR));
            const snap = await getDocs(q);
            const t = document.getElementById('tabelaRelatorio'); t.innerHTML = "";
            window.dadosPDF = [];
            snap.forEach(d => {
                t.innerHTML += `<tr><td>${d.data().nome}</td><td>${d.data().hora}</td></tr>`;
                window.dadosPDF.push([d.data().nome, d.data().hora]);
            });
        };

        window.baixarPDF = () => {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.autoTable({ head: [['Nome', 'Hora']], body: window.dadosPDF });
            doc.save("frequencia.pdf");
        };

        window.filtrarAlunos = () => { const v = document.getElementById('buscaA').value.toLowerCase(); document.querySelectorAll('#tabelaAlunos tr').forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(v) ? "" : "none"); };
        window.filtrarLogins = () => { const v = document.getElementById('buscaL').value.toLowerCase(); document.querySelectorAll('#tabelaLogins tr').forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(v) ? "" : "none"); };
        window.del = async (c, i) => { if(confirm("Excluir?")) await deleteDoc(doc(db, c, i)); };

        function updateCharts() {
            const t = parseInt(document.getElementById('st-total').innerText);
            const p = parseInt(document.getElementById('st-presentes').innerText);
            if(chartP) chartP.destroy();
            chartP = new Chart(document.getElementById('chartPizza'), { type: 'doughnut', data: { labels: ['Presen√ßas', 'Faltas'], datasets: [{ data: [p, t-p], backgroundColor: ['#10b981', '#cc0000'] }] } });
            if(chartB) chartB.destroy();
            chartB = new Chart(document.getElementById('chartBarras'), { type: 'bar', data: { labels: ['Total', 'Presentes'], datasets: [{ label: 'Qtd', data: [t, p], backgroundColor: ['#003399', '#10b981'] }] } });
        }

        document.getElementById('btnL').onclick = async () => {
            const perms = Array.from(document.querySelectorAll('.pc:checked')).map(c => c.value);
            await addDoc(collection(db, "logins"), { usuario: document.getElementById('lu').value, senha: document.getElementById('ls').value, email: document.getElementById('le').value, permissoes: perms });
            alert("Criado!");
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>