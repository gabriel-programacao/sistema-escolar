<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcessaEdu | Master Elite Hub</title>

    <link rel="icon" type="image/png" href="Icone_acessaedu.ico">
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #003399; --accent: #ffcc00; --bg-body: #f8fafc; --sidebar-w: 280px; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: #1e293b; margin: 0; }

        .sidebar { width: var(--sidebar-w); background: linear-gradient(180deg, #001a4d 0%, #003399 100%); height: 100vh; position: fixed; padding: 30px 20px; color: white; z-index: 1000; box-shadow: 10px 0 30px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .nav-link-pe { color: rgba(255,255,255,0.7); padding: 14px 18px; border-radius: 16px; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; transition: 0.3s; text-decoration: none; font-weight: 500; }
        .nav-link-pe:hover, .nav-link-pe.active { background: rgba(255,255,255,0.15); color: var(--accent); transform: translateX(5px); }
        .nav-link-pe.active { background: var(--accent); color: var(--primary); font-weight: 700; }

        .main-content { margin-left: var(--sidebar-w); padding: 40px; min-height: 100vh; }
        .card-premium { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); border-radius: 24px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.03); margin-bottom: 30px; }
        
        .stat-box { padding: 25px; border-radius: 24px; color: white; position: relative; overflow: hidden; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .stat-box i { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.15; transform: rotate(-15deg); }

        .secao { display: none; }
        .ativa { display: block; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .user-item { background: #f8fafc; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }

        .modal-content { border-radius: 30px; border: none; }
        .nav-pills .nav-link { color: var(--primary); font-weight: 600; border-radius: 12px; padding: 10px 20px; }
        .nav-pills .nav-link.active { background-color: var(--primary); color: white; }
        .form-label-bold { font-weight: 700; font-size: 0.85rem; color: var(--primary); margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="text-center mb-5">
            <img src="logo_acessaedu.png" height="70" class="mb-3">
            <h5 class="fw-bold text-white mb-0">Acessa <span class="text-warning">Edu</span></h5>
            <small class="opacity-50">Controle Global v4.0</small>
        </div>
        <nav>
            <a href="#" class="nav-link-pe active" onclick="window.trocarAba('sec-resumo', this)"><i class="fas fa-chart-pie"></i> Visão Geral</a>
            <a href="#" class="nav-link-pe" onclick="window.trocarAba('sec-unidades', this)"><i class="fas fa-university"></i> Unidades Contratantes</a>
            <a href="#" class="nav-link-pe" onclick="window.trocarAba('sec-logs', this)"><i class="fas fa-list-ul"></i> Logs do Sistema</a>
        </nav>
        <div class="mt-auto">
            <button class="btn btn-danger w-100 rounded-4 py-3 fw-bold" onclick="window.logoutMaster()"><i class="fas fa-power-off me-2"></i>SAIR</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div><h3 class="fw-bold mb-1">Olá, Gabriel</h3><p class="text-muted mb-0">Gerencie suas licenças e acessos SaaS.</p></div>
            <div class="bg-white p-2 px-3 rounded-4 shadow-sm fw-bold"><i class="fas fa-crown text-warning me-2"></i>Administrador Master</div>
        </div>

        <div id="sec-resumo" class="secao ativa">
            <div class="row g-4 mb-5">
                <div class="col-md-4"><div class="stat-box" style="background: linear-gradient(135deg, #4f46e5, #3730a3);"> <small>INSTITUIÇÕES</small><h1 id="dash-escolas">0</h1><i class="fas fa-school"></i></div></div>
                <div class="col-md-4"><div class="stat-box" style="background: linear-gradient(135deg, #10b981, #059669);"> <small>ALUNOS GLOBAIS</small><h1 id="dash-alunos">0</h1><i class="fas fa-user-graduate"></i></div></div>
                <div class="col-md-4"><div class="stat-box" style="background: linear-gradient(135deg, #ef4444, #dc2626);"> <small>BLOQUEADAS</small><h1 id="dash-bloq">0</h1><i class="fas fa-lock"></i></div></div>
            </div>
        </div>

        <div id="sec-unidades" class="secao">
            <div class="card-premium">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0 text-primary">Unidades Contratantes</h5>
                    <button class="btn btn-primary rounded-4 fw-bold px-4" data-bs-toggle="modal" data-bs-target="#modalNovoCadastro">+ NOVA UNIDADE</button>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">INSTITUIÇÃO</th>
                                <th>DATABASE</th>
                                <th>COTA</th>
                                <th>STATUS</th>
                                <th class="text-end pe-4">AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaEscolas"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-logs" class="secao">
            <div class="card-premium">
                <h5 class="fw-bold mb-4">Auditoria Global</h5>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light"><tr><th>Data</th><th>Escola</th><th>Ação</th><th>Detalhes</th></tr></thead>
                        <tbody id="tabelaLogsGlobal"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalNovoCadastro" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header border-0 p-4">
                    <h5 class="fw-bold m-0 text-primary">Cadastrar Nova Unidade</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 pt-0">
                    <div class="row g-3">
                        <div class="col-md-4"><label class="form-label-bold">ID Database</label><input type="text" id="nID" class="form-control" placeholder="ex: ete_mac"></div>
                        <div class="col-md-8"><label class="form-label-bold">Nome da Instituição</label><input type="text" id="nNome" class="form-control" placeholder="Nome da Escola"></div>
                        <div class="col-md-4"><label class="form-label-bold">Cota de Alunos</label><input type="number" id="nLimite" class="form-control" value="50"></div>
                        <div class="col-md-8"><label class="form-label-bold">Turmas (Separe por vírgula)</label><input type="text" id="nTurmas" class="form-control" placeholder="1º ADM, 2º REDES"></div>
                        
                        <div class="col-12"><hr></div>
                        <h6 class="fw-bold text-primary mb-2"><i class="fas fa-user-shield me-2"></i>Acesso Diretor (Obrigatório)</h6>
                        <div class="col-md-6"><label class="form-label-bold">E-mail</label><input type="email" id="nEmail" class="form-control"></div>
                        <div class="col-md-6"><label class="form-label-bold">Senha</label><input type="password" id="nSenha" class="form-control"></div>

                        <div class="col-12"><hr></div>
                        <h6 class="fw-bold text-success mb-2"><i class="fab fa-whatsapp me-2"></i>WhatsApp API (Opcional)</h6>
                        <div class="col-md-4"><label class="form-label-bold">Instance ID</label><input type="text" id="nZInst" class="form-control"></div>
                        <div class="col-md-4"><label class="form-label-bold">Token</label><input type="text" id="nZTok" class="form-control"></div>
                        <div class="col-md-4"><label class="form-label-bold">Client Token</label><input type="text" id="nZCli" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button class="btn btn-primary rounded-3 fw-bold px-5" onclick="window.executarCadastroCompleto()">CADASTRAR UNIDADE</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEscola" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="fw-bold" id="modalEscolaTitulo">Gerenciar Unidade</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-geral">Geral</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-acessos">Acessos</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-cotas">Cotas</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-api">API</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-geral">
                            <div class="row g-3">
                                <div class="col-md-4"><label class="small fw-bold">ID Database</label><input type="text" id="editID" class="form-control bg-light" readonly></div>
                                <div class="col-md-8"><label class="small fw-bold">Nome</label><input type="text" id="editNome" class="form-control"></div>
                                <div class="col-12 text-end mt-3"><button class="btn btn-primary rounded-3" onclick="window.salvarConfigGeral()">Atualizar</button></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-acessos">
                            <div id="listaUsuariosEscola" class="mb-4"></div>
                            <div class="bg-light p-3 rounded-4 border">
                                <small class="fw-bold d-block mb-2 text-primary">ADICIONAR DIRETOR</small>
                                <div class="row g-2">
                                    <div class="col-md-5"><input type="email" id="newUserEmail" class="form-control" placeholder="E-mail"></div>
                                    <div class="col-md-4"><input type="password" id="newUserPass" class="form-control" placeholder="Senha"></div>
                                    <div class="col-md-3"><button class="btn btn-primary w-100" onclick="window.criarNovoUsuario()">CRIAR</button></div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-cotas">
                            <div class="row g-3">
                                <div class="col-md-4"><label class="small fw-bold">Cota</label><input type="number" id="editLimite" class="form-control"></div>
                                <div class="col-md-8"><label class="small fw-bold">Turmas</label><input type="text" id="editTurmas" class="form-control"></div>
                                <div class="col-12 text-end mt-3"><button class="btn btn-primary rounded-3" onclick="window.salvarConfigGeral()">Salvar</button></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-api">
                            <div class="row g-3">
                                <div class="col-md-6"><input type="text" id="editZInst" class="form-control" placeholder="Instance ID"></div>
                                <div class="col-md-6"><input type="text" id="editZTok" class="form-control" placeholder="Token"></div>
                                <div class="col-12"><input type="text" id="editZCli" class="form-control" placeholder="Client Token"></div>
                                <div class="col-12 text-end mt-3"><button class="btn btn-primary rounded-3" onclick="window.salvarConfigGeral()">Configurar</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc, getDocs, query, where, addDoc, serverTimestamp, orderBy, limit, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDgR98RtL8sgxVbEV2Swyb2wnHLSPt3cDo", authDomain: "escolapro-15e5e.firebaseapp.com", projectId: "escolapro-15e5e", storageBucket: "escolapro-15e5e.firebasestorage.app", messagingSenderId: "339019791514", appId: "1:339019791514:web:44e0d58b6835f0fe6df323" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const secondaryAuth = getAuth(initializeApp(firebaseConfig, "Secondary"));

        let escolaAtualId = "";
        const toast = (m, i = 'success') => Swal.fire({ title: m, icon: i, confirmButtonColor: '#003399' });

        onAuthStateChanged(auth, user => { if (!user || user.email !== "gabriel.tec.redes@gmail.com") window.location.href = 'index.html'; });

        // CADASTRO COMPLETO
        window.executarCadastroCompleto = async () => {
            const id = document.getElementById('nID').value.trim();
            const nome = document.getElementById('nNome').value.trim();
            const email = document.getElementById('nEmail').value.trim();
            const senha = document.getElementById('nSenha').value.trim();
            
            if(!id || !nome || !email || senha.length < 6) return toast("Preencha todos os campos obrigatórios!", "warning");

            try {
                Swal.showLoading();
                await createUserWithEmailAndPassword(secondaryAuth, email, senha);
                const turmas = document.getElementById('nTurmas').value.split(',').map(t => t.trim()).filter(t => t !== "");
                await setDoc(doc(db, "unidades", id), {
                    escolaId: id, nome, status: 'Ativo', limiteAlunos: parseInt(document.getElementById('nLimite').value),
                    turmas, z_instance: document.getElementById('nZInst').value, z_token: document.getElementById('nZTok').value, z_client: document.getElementById('nZCli').value
                });
                await setDoc(doc(db, "logins", email), { email, senha, escolaId: id, usuario: email.split('@')[0] });
                await signOut(secondaryAuth);
                bootstrap.Modal.getInstance(document.getElementById('modalNovoCadastro')).hide();
                toast("Cadastrado com sucesso!");
            } catch (err) { toast(err.message, "error"); }
        };

        // DASHBOARD GLOBAL
        onSnapshot(collection(db, "unidades"), snap => {
            const t = document.getElementById('tabelaEscolas'); t.innerHTML = "";
            let bloq = 0;
            snap.forEach(d => {
                const e = d.data(); if(e.status === 'Bloqueado') bloq++;
                t.innerHTML += `<tr><td class="ps-4"><strong>${e.nome}</strong></td><td><code>${e.escolaId}</code></td><td>${e.limiteAlunos}</td><td><span class="badge rounded-pill ${e.status === 'Ativo' ? 'bg-success' : 'bg-danger'}">${e.status}</span></td><td class="text-end pe-4"><button class="btn btn-sm btn-light text-danger me-2" onclick="window.alterarStatus('${e.escolaId}', '${e.status}')"><i class="fas fa-lock"></i></button><button class="btn btn-sm btn-outline-primary rounded-3" onclick="window.abrirGerenciamento('${e.escolaId}')">GERENCIAR</button></td></tr>`;
            });
            document.getElementById('dash-escolas').innerText = snap.size;
            document.getElementById('dash-bloq').innerText = bloq;
        });

        // --- CORREÇÃO: ALUNOS GLOBAIS ---
        onSnapshot(collection(db, "alunos"), snap => {
            document.getElementById('dash-alunos').innerText = snap.size;
        });

        window.alterarStatus = async (id, st) => {
            const n = st === 'Ativo' ? 'Bloqueado' : 'Ativo';
            await updateDoc(doc(db, "unidades", id), { status: n });
            toast(`Unidade ${n}!`);
        };

        window.abrirGerenciamento = async (id) => {
            escolaAtualId = id;
            const docSnap = await getDoc(doc(db, "unidades", id));
            if (docSnap.exists()) {
                const e = docSnap.data();
                document.getElementById('editID').value = e.escolaId;
                document.getElementById('editNome').value = e.nome;
                document.getElementById('editLimite').value = e.limiteAlunos;
                document.getElementById('editTurmas').value = e.turmas ? e.turmas.join(", ") : "";
                document.getElementById('editZInst').value = e.z_instance || "";
                document.getElementById('editZTok').value = e.z_token || "";
                document.getElementById('editZCli').value = e.z_client || "";
                window.carregarUsuarios();
                new bootstrap.Modal(document.getElementById('modalEscola')).show();
            }
        };

        window.salvarConfigGeral = async () => {
            const turmas = document.getElementById('editTurmas').value.split(',').map(t => t.trim()).filter(t => t !== "");
            await updateDoc(doc(db, "unidades", escolaAtualId), { nome: document.getElementById('editNome').value, limiteAlunos: parseInt(document.getElementById('editLimite').value), turmas: turmas, z_instance: document.getElementById('editZInst').value.trim(), z_token: document.getElementById('editZTok').value.trim(), z_client: document.getElementById('editZCli').value.trim() });
            toast("Atualizado!");
        };

        window.carregarUsuarios = async () => {
            const snap = await getDocs(query(collection(db, "logins"), where("escolaId", "==", escolaAtualId)));
            const container = document.getElementById('listaUsuariosEscola'); container.innerHTML = "";
            snap.forEach(d => { container.innerHTML += `<div class="user-item p-3 mb-2 bg-light rounded-3 d-flex justify-content-between"><span>${d.data().email}</span><button class="btn btn-sm btn-danger" onclick="window.excluirUser('${d.id}')"><i class="fas fa-trash"></i></button></div>`; });
        };

        window.criarNovoUsuario = async () => {
            const e = document.getElementById('newUserEmail').value, p = document.getElementById('newUserPass').value;
            if(!e || p.length < 6) return toast("Dados inválidos!", "error");
            try { await createUserWithEmailAndPassword(secondaryAuth, e, p); await setDoc(doc(db, "logins", e), { email: e, senha: p, escolaId: escolaAtualId, usuario: e.split('@')[0] }); await signOut(secondaryAuth); toast("Diretor criado!"); window.carregarUsuarios(); } catch (err) { toast(err.message, "error"); }
        };

        window.excluirUser = async id => { if(confirm("Remover acesso?")) { await deleteDoc(doc(db, "logins", id)); window.carregarUsuarios(); } };
        window.logoutMaster = () => { signOut(auth); window.location.href = 'index.html'; };
        window.trocarAba = (id, btn) => { 
            document.querySelectorAll('.secao').forEach(s => s.classList.remove('ativa'));
            document.getElementById(id).classList.add('ativa');
            document.querySelectorAll('.nav-link-pe').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(id === 'sec-logs') escutarLogsGlobal();
        };

        function escutarLogsGlobal() {
            onSnapshot(query(collection(db, "logs_atividades"), orderBy("dataHora", "desc"), limit(50)), snap => {
                const t = document.getElementById('tabelaLogsGlobal'); t.innerHTML = "";
                snap.forEach(d => { const l = d.data(); t.innerHTML += `<tr><td><small>${l.dataHora?.toDate().toLocaleDateString()}</small></td><td>${l.escolaId}</td><td>${l.acao}</td><td><small>${l.detalhes}</small></td></tr>`; });
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>